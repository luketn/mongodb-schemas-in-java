<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Sea Surface Temperatures Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin=""/>
    <style>
        body {
            background: #f4f7fa;
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        #map1 {
            height: 600px;
            width: 98vw;
            max-width: 1200px;
            margin: 0 auto 32px auto;
            border-radius: 14px;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.07);
            border: 1px solid #e3e8ee;
        }

        @media (max-width: 700px) {
            #map1 {
                height: 350px;
            }
        }

        .header-bar {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 32px 0 16px 0;
            text-align: center;
            margin-bottom: 18px;
        }
        .header-bar h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 600;
            letter-spacing: 0.03em;
            color: #2a3b4d;
        }
        .header-bar .buyline {
            margin-top: 8px;
            font-size: 1.1rem;
            color: #4a5a6a;
            font-weight: 400;
        }
        .header-bar .buyline a {
            text-decoration: none;
            color: #2a7ae2;
            transition: color 0.2s;
        }
        .header-bar .buyline a:hover {
            color: #e26a2a;
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="header-bar">
    <h1>MongoDB Schemas in Java</h1>
    <div class="buyline">Demonstration using MongoDB sample database '<a href="https://www.mongodb.com/docs/guides/atlas/sample-data/">sample-weather</a>'</div>
</div>
<div id="map1" tabindex="0"></div>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" crossorigin=""></script>
<script>
    // --- Map setup ---
    var defaultCenter = [53.3899, -1.4678]; //London, UK
    var defaultZoom = 6;
    var mymap = L.map("map1", {})
    L.control.scale({metric: true, imperial: false, position: 'bottomleft'}).addTo(mymap);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(mymap);

    var markersLayer = L.layerGroup().addTo(mymap);

    // --- SSE fetch and marker update ---
    var currentSSE = null;

    function fetchSeaTemps() {
        // Remove old markers
        markersLayer.clearLayers();
        // Abort previous SSE if any
        if (currentSSE) currentSSE.close();

        function normalizeLongitude(lng) {
            if (lng > 179.999999) {
                return 179.999999;
            }
            if (lng < -179.999999) {
                return -179.999999;
            }
            return lng;
        }

        function getNormalizedBounds(map) {
            const bounds = map.getBounds();
            return {
                north: bounds.getNorth(),
                south: bounds.getSouth(),
                east: normalizeLongitude(bounds.getEast()),
                west: normalizeLongitude(bounds.getWest())
            };
        }

        const bounds = getNormalizedBounds(mymap);

        // Build query string
        var params = [];
        params.push("queryType=BoundingBox");
        params.push("south=" + bounds.south);
        params.push("west=" + bounds.west);
        params.push("north=" + bounds.north);
        params.push("east=" + bounds.east);
        var url = "/weather/sea/temperature?" + params.join("&");

        // Open SSE connection
        currentSSE = new EventSource(url);
        currentSSE.onmessage = function (event) {
            // Each event is a JSON array of SeaTemperature objects
            var temps = JSON.parse(event.data);
            temps.forEach(function (t) {
                var marker = L.circleMarker([t.lat, t.lon], {
                    alt: `${t.temp.toFixed(2)}°C (Latitude: ${t.lat}, Longitude: ${t.lon})"`,
                    radius: 6,
                    fillColor: getColor(t.temp),
                    color: "#333",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup("Temperature: " + t.temp.toFixed(2) + "°C");
                markersLayer.addLayer(marker);
            });
        };
        currentSSE.onerror = function () {
            currentSSE.close();
        };
    }

    // --- Color scale for temperature ---
    function getColor(temp) {
        // Simple blue (cold) to red (hot) scale
        var min = 0, max = 30;
        var pct = Math.max(0, Math.min(1, (temp - min) / (max - min)));
        var r = Math.round(255 * pct);
        var b = Math.round(255 * (1 - pct));
        return "rgb(" + r + ",50," + b + ")";
    }


    // --- Initial load ---
    function initializeMap(position, zoom) {
        mymap.setView(position, zoom);
        fetchSeaTemps();

        //hook up moveend event to refetch data
        mymap.on('moveend', function () {
            fetchSeaTemps();
        });
    }

    if (navigator.geolocation) {
        // Try to get user's location
        navigator.geolocation.getCurrentPosition(
            function (pos) {
                var lat = pos.coords.latitude;
                var lon = pos.coords.longitude;
                initializeMap([lat, lon], defaultZoom);
            },
            function (error) {
                console.error('Geolocation error:', error);
                initializeMap(defaultCenter, defaultZoom);
            }
        );
    } else {
        initializeMap(defaultCenter, defaultZoom);
    }
</script>
</body>
</html>
